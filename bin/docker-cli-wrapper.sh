#!/usr/bin/env bash
set -euo pipefail

# Docker CLI wrapper for Gesture Apps session containers
# This script restricts Docker commands to only those needed for session management.
#
# Security features:
# - Only allows specific Docker subcommands (run, stop, rm, ps, inspect)
# - Container names must match pattern: session-{appId}-{sessionId}
# - Only allows {appId}-gestures-app images for 'run' command
#
# Usage:
#   The script is executed from within the lobby container via bash:
#   bash /app/bin/docker-cli-wrapper.sh <command> [args...]
#
#   The container has access to the host Docker daemon via mounted socket.

# Allowed subcommands
ALLOWED_CMDS=("run" "stop" "rm" "ps" "inspect")

# Container name pattern: session-{appId}-{sessionId}
# appId can contain lowercase letters, numbers, and hyphens
# sessionId is alphanumeric (6 chars, generated by lobby)
CONTAINER_RE='^session-[a-z0-9-]+-[a-z0-9]+$'

# Image name pattern: {appId}-gestures-app
IMAGE_RE='^[a-z0-9-]+-gestures-app$'

# Docker binary (will be found in PATH when docker.io is installed)
# Defaults to 'docker' (found in PATH) but can be overridden via DOCKER_BIN env var
DOCKER_BIN="${DOCKER_BIN:-docker}"

# Validation mode for testing
do_exec() {
  if [[ "${WRAPPER_VALIDATE_ONLY:-}" == "1" ]]; then
    printf '%s' "${DOCKER_BIN}"
    for arg in "$@"; do
      printf ' %q' "${arg}"
    done
    echo
    exit 0
  fi
  exec "${DOCKER_BIN}" "$@"
}

# Get the command
cmd="${1:-}"
shift || true

# Validate command is allowed
case " ${ALLOWED_CMDS[*]} " in
  *" ${cmd} "*)
    ;;
  *)
    echo "Denied: command '${cmd}' not allowed" >&2
    exit 1
    ;;
esac

# Handle commands that don't require container name validation
if [[ "${cmd}" == "ps" ]]; then
  # Restrict ps to only show session containers
  do_exec ps --filter "name=^session-" --format '{{.Names}} {{.Status}}'
fi

# Handle 'run' command specially
if [[ "${cmd}" == "run" ]]; then
  args=("$@")
  container_name=""
  image_name=""
  
  # Find container name from --name parameter
  for i in "${!args[@]}"; do
    if [[ "${args[$i]}" == "--name" ]] && [[ $((i+1)) -lt ${#args[@]} ]]; then
      container_name="${args[$((i+1))]}"
      break
    fi
  done
  
  # Validate container name
  if [[ -z "${container_name}" ]] || [[ ! "${container_name}" =~ ${CONTAINER_RE} ]]; then
    echo "Denied: invalid or missing container name (must match session-{appId}-{sessionId})" >&2
    exit 1
  fi
  
  # Find image name (last non-flag argument)
  for (( i=${#args[@]}-1; i>=0; i-- )); do
    arg="${args[$i]}"
    if [[ ! "${arg}" =~ ^- ]] && [[ -n "${arg}" ]]; then
      image_name="${arg}"
      break
    fi
  done
  
  # Validate image name
  if [[ -z "${image_name}" ]] || [[ "${image_name}" == -* ]]; then
    echo "Denied: invalid image name" >&2
    exit 1
  fi
  
  if [[ ! "${image_name}" =~ ${IMAGE_RE} ]]; then
    echo "Denied: only '{appId}-gestures-app' images are allowed" >&2
    exit 1
  fi
  
  do_exec run "$@"
fi

# Handle 'inspect' command
if [[ "${cmd}" == "inspect" ]]; then
  args=("$@")
  container_name=""
  
  # Find container name (last non-flag argument)
  for (( i=${#args[@]}-1; i>=0; i-- )); do
    arg="${args[$i]}"
    if [[ ! "${arg}" =~ ^- ]] && [[ -n "${arg}" ]]; then
      container_name="${arg}"
      break
    fi
  done
  
  if [[ -z "${container_name}" ]] || [[ ! "${container_name}" =~ ${CONTAINER_RE} ]]; then
    echo "Denied: invalid or missing container name for inspect" >&2
    exit 1
  fi
  
  do_exec inspect "$@"
fi

# Handle 'stop' and 'rm' commands (require container name as first arg)
if [[ "${cmd}" == "stop" ]] || [[ "${cmd}" == "rm" ]]; then
  name="${1:-}"
  shift || true
  
  if [[ -z "${name}" ]] || [[ ! "${name}" =~ ${CONTAINER_RE} ]]; then
    echo "Denied: invalid container name" >&2
    exit 1
  fi
  
  do_exec "${cmd}" "${name}" "$@"
fi
